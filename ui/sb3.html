<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SB3 - Scanner Box 3</title>
  <style>
    :root {
      --bg-dark: #0a0d11;
      --bg-card: #0f1318;
      --bg-panel: #121618;
      --text-primary: #e4e8f0;
      --text-secondary: #8a92a8;
      --accent: #2dd4bf;
      --accent-dim: rgba(45, 212, 191, 0.3);
      --accent-glow: rgba(45, 212, 191, 0.15);
      --border: #1e2530;
      --good: #10b981;
      --bad: #ef4444;
      --warn: #f59e0b;
      --slider-track: rgba(45, 212, 191, 0.08);
      --slider-glow: 0 0 8px rgba(45, 212, 191, 0.25), inset 0 1px 2px rgba(45, 212, 191, 0.1);
    }

    /* Red theme for dark environments */
    body.red-theme {
      --accent: #b91c1c;
      --accent-dim: rgba(185, 28, 28, 0.3);
      --accent-glow: rgba(185, 28, 28, 0.15);
      --good: #b91c1c;
      --slider-track: rgba(185, 28, 28, 0.08);
      --slider-glow: 0 0 8px rgba(185, 28, 28, 0.25), inset 0 1px 2px rgba(185, 28, 28, 0.1);
      --text-primary: #8a92a8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 14px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 16px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      position: relative;
    }

    .header-left {
      position: absolute;
      left: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--accent);
      text-transform: uppercase;
      padding: 4px 8px;
      border: 1px solid var(--accent);
      border-radius: 4px;
    }

    .status-indicators {
      display: flex;
      gap: 12px;
      font-size: 12px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--bad);
    }

    .status-dot.active {
      background: var(--good);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .last-hit {
      font-family: monospace;
      color: var(--accent);
      font-size: 24px;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.15s ease;
    }

    .last-hit.holding {
      color: var(--warn);
    }

    .connection-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      background: var(--bg-panel);
    }

    .connection-status.connected { color: var(--good); }
    .connection-status.disconnected { color: var(--bad); }

    .theme-toggle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      margin-left: 8px;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    body.red-theme .theme-toggle {
      background: rgba(220, 38, 38, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Main Layout */
    .main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .grid-full {
      grid-column: 1 / -1;
    }

    /* Widget */
    .widget {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .widget.collapsed .widget-body {
      display: none;
    }

    .widget-header {
      padding: 12px 16px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .widget-body {
      padding: 16px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .tab {
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 500;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .tab:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-dark);
    }

    /* Controls */
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .control-value {
      font-family: monospace;
      color: var(--accent);
    }

    .control-applied {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--slider-track);
      box-shadow: var(--slider-glow);
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid var(--bg-dark);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid var(--bg-dark);
      cursor: pointer;
    }

    .slider.dirty {
      background: linear-gradient(90deg, var(--accent-dim), var(--bg-panel));
    }

    /* Profiles */
    .profiles-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .profile-btn {
      padding: 10px 12px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 12px;
      text-align: left;
      transition: all 0.15s;
    }

    .profile-btn:hover {
      border-color: var(--accent);
    }

    .profile-btn.active {
      border-color: var(--accent);
      background: rgba(45, 212, 191, 0.1);
    }

    .profile-btn .label {
      font-weight: 500;
    }

    .profile-btn .meta {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Counters */
    .counter-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .counter-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .counter-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      font-family: monospace;
    }

    .counter-rate {
      font-size: 11px;
      color: var(--good);
      margin-top: 4px;
    }

    /* Hit List */
    .hit-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-height: 250px;
      overflow-y: auto;
    }

    .hit-row {
      display: grid;
      grid-template-columns: 70px 1fr 50px;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg-panel);
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }

    .hit-row .time { color: var(--text-secondary); }
    .hit-row .freq { color: var(--accent); }
    .hit-row .duration { color: var(--text-secondary); text-align: right; }

    .hit-row.header {
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }

    /* Buttons */
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    button.action {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }

    button.action:hover { border-color: var(--accent); }
    button.action:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ADS-B */
    .adsb-frame {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 4px;
      background: var(--bg-panel);
    }

    .adsb-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-secondary);
      gap: 12px;
    }

    .adsb-placeholder .icon {
      font-size: 48px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state .icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    /* Responsive */
    @media (max-width: 700px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">SB3</div>
    </div>
    <div class="last-hit" id="last-hit">--</div>
    <div class="header-right">
      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle red theme">üî¥</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="grid">

      <!-- Row 1: Controls + Profiles -->
      <div class="widget">
        <div class="widget-header">
          <span>‚öôÔ∏è Radio Controls</span>
          <div class="tabs">
            <button class="tab active" id="tab-airband" onclick="switchTarget('airband')">Airband</button>
            <button class="tab" id="tab-ground" onclick="switchTarget('ground')">Ground</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="control-group">
            <div class="control-item">
              <div class="control-label">
                <span>Gain (dB)</span>
                <span class="control-value" id="gain-value">--</span>
              </div>
              <input type="range" class="slider" id="gain-slider" min="0" max="28" step="1" value="14">
              <div class="control-applied">Applied: <span id="gain-applied">--</span></div>
            </div>

            <div class="control-item">
              <div class="control-label">
                <span>Squelch (SNR)</span>
                <span class="control-value" id="sql-value">--</span>
              </div>
              <input type="range" class="slider" id="sql-slider" min="0" max="10" step="0.1" value="5">
              <div class="control-applied">Applied: <span id="sql-applied">--</span></div>
            </div>

            <div class="control-item">
              <div class="control-label">
                <span>Filter (Hz)</span>
                <span class="control-value" id="filter-value">--</span>
              </div>
              <input type="range" class="slider" id="filter-slider" min="2000" max="5000" step="100" value="3500">
              <div class="control-applied">Applied: <span id="filter-applied">--</span></div>
            </div>
          </div>

          <div class="btn-row">
            <button class="action" id="btn-play">Play</button>
            <button class="action" id="btn-avoid">Avoid</button>
            <button class="action" id="btn-clear-avoids">Clear</button>
            <button class="action" id="btn-reconnect">Reconnect</button>
          </div>
        </div>
      </div>

      <div class="widget">
        <div class="widget-header">üéØ Profiles</div>
        <div class="widget-body">
          <div class="profiles-grid" id="profiles-list">
            <div class="empty-state">
              <div class="icon">üì°</div>
              <div>Loading profiles...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 2: Hit Counters + Hit List -->
      <div class="widget">
        <div class="widget-header">üìä Signal Activity</div>
        <div class="widget-body">
          <div class="counter-grid">
            <div class="counter-item">
              <div class="counter-label">Hits/Hour</div>
              <div class="counter-value" id="hit-count">--</div>
              <div class="counter-rate" id="hit-rate"></div>
            </div>
            <div class="counter-item">
              <div class="counter-label">Session</div>
              <div class="counter-value" id="session-count">0</div>
              <div class="counter-rate" id="session-start">--</div>
            </div>
            <div class="counter-item">
              <div class="counter-label">Avoids</div>
              <div class="counter-value" id="avoids-count">--</div>
              <div class="counter-rate" id="avoids-target"></div>
            </div>
            <div class="counter-item">
              <div class="counter-label">Local Time</div>
              <div class="counter-value" id="pi-time">--</div>
            </div>
          </div>
        </div>
      </div>

      <div class="widget">
        <div class="widget-header">üìã Recent Hits</div>
        <div class="widget-body">
          <div class="hit-list" id="hit-list">
            <div class="hit-row header">
              <div>Time</div>
              <div>Frequency</div>
              <div>Dur</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 3: ADS-B (full width) -->
      <div class="widget grid-full">
        <div class="widget-header">
          ‚úàÔ∏è ADS-B Traffic
        </div>
        <div class="widget-body" id="adsb-body" style="padding: 0;">
          <iframe src="https://adsb.lol" class="adsb-frame" id="adsb-frame" allow="geolocation"></iframe>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    
    const GAIN_STEPS = [
      0.0, 0.9, 1.4, 2.7, 3.7, 7.7, 8.7, 12.5, 14.4, 15.7,
      16.6, 19.7, 20.7, 22.9, 25.4, 28.0, 29.7, 32.8, 33.8,
      36.4, 37.2, 38.6, 40.2, 42.1, 43.4, 43.9, 44.5, 48.0, 49.6,
    ];
    const SQL_SCALE = 0.1;
    const DEBOUNCE_MS = 500;
    
    // ============================================
    // STATE
    // ============================================
    
    let activeTarget = 'airband';
    
    let state = {
      connected: false,
      sdr1Active: false,
      sdr2Active: false,
      icecastActive: false,
      eventSource: null,
      lastHit: '',
      hits: [],
      holdFreq: null,
      sessionHits: 0,
      sessionStart: Date.now(),
      applyTimeout: null,
      filterTimeout: null,
      serverTime: null,
      airband: {
        gain: 32.8,
        squelch: 0.5,
        filter: 3500,
        profiles: [],
        currentProfile: '',
        avoids: [],
      },
      ground: {
        gain: 32.8,
        squelch: 0.5,
        filter: 3500,
        profiles: [],
        currentProfile: '',
        avoids: [],
      },
    };
    
    // ============================================
    // ELEMENTS
    // ============================================
    
    const els = {
      lastHit: document.getElementById('last-hit'),
      gainSlider: document.getElementById('gain-slider'),
      gainValue: document.getElementById('gain-value'),
      gainApplied: document.getElementById('gain-applied'),
      sqlSlider: document.getElementById('sql-slider'),
      sqlValue: document.getElementById('sql-value'),
      sqlApplied: document.getElementById('sql-applied'),
      filterSlider: document.getElementById('filter-slider'),
      filterValue: document.getElementById('filter-value'),
      filterApplied: document.getElementById('filter-applied'),
      profilesList: document.getElementById('profiles-list'),
      hitList: document.getElementById('hit-list'),
      hitCount: document.getElementById('hit-count'),
      hitRate: document.getElementById('hit-rate'),
      sessionCount: document.getElementById('session-count'),
      sessionStart: document.getElementById('session-start'),
      avoidsCount: document.getElementById('avoids-count'),
      avoidsTarget: document.getElementById('avoids-target'),
      piTime: document.getElementById('pi-time'),
      tabAirband: document.getElementById('tab-airband'),
      tabGround: document.getElementById('tab-ground'),
      btnReconnect: document.getElementById('btn-reconnect'),
    };
    
    // ============================================
    // COLLAPSIBLE WIDGETS
    // ============================================
    
    function toggleWidget(widget, collapsedState) {
      if (!widget) return;
      const shouldCollapse = typeof collapsedState === 'boolean'
        ? collapsedState
        : !widget.classList.contains('collapsed');
      widget.classList.toggle('collapsed', shouldCollapse);
      const btn = widget.querySelector('.collapse-btn');
      if (btn) {
        btn.textContent = shouldCollapse ? '‚ñ∂' : '‚ñº';
      }
    }
    
    function setupCollapsibleWidgets() {
      document.querySelectorAll('.widget').forEach(widget => {
        const header = widget.querySelector('.widget-header');
        const body = widget.querySelector('.widget-body');
        if (!header || !body) return;
        
        header.addEventListener('click', (e) => {
          // Ignore clicks on interactive elements inside the header (e.g. tabs)
          if (e.target.closest('button, .tab, a, input, select, textarea')) {
            return;
          }
          toggleWidget(widget);
        });
      });
    }
    
    // ============================================
    // API
    // ============================================
    
    async function fetchJSON(url) {
      const r = await fetch(url, { cache: 'no-store' });
      return r.json();
    }
    
    async function postAPI(endpoint, data) {
      const body = new URLSearchParams(data).toString();
      const r = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      return r.json();
    }
    
    // ============================================
    // GAIN HELPERS
    // ============================================
    
    function gainIndexFromValue(value) {
      let best = 0;
      let bestDiff = Infinity;
      GAIN_STEPS.forEach((g, idx) => {
        const diff = Math.abs(g - value);
        if (diff < bestDiff) {
          bestDiff = diff;
          best = idx;
        }
      });
      return best;
    }
    
    function gainValueFromIndex(idx) {
      return GAIN_STEPS[Math.min(idx, GAIN_STEPS.length - 1)];
    }
    
    // ============================================
    // UI UPDATES
    // ============================================
    
    function getLiveDisplayFreq() {
      const topHit = state.hits[0];
      if (topHit && topHit.freq) {
        const num = parseFloat(topHit.freq);
        return isNaN(num) ? (topHit.freq || '--') : formatFreq(num) + ' MHz';
      }
      if (state.lastHit) {
        const num = parseFloat(state.lastHit);
        return isNaN(num) ? state.lastHit : formatFreq(num) + ' MHz';
      }
      return '--';
    }

    function updateStatus() {
      const display = state.holdFreq || getLiveDisplayFreq();
      els.lastHit.textContent = display || '--';
      els.lastHit.classList.toggle('holding', Boolean(state.holdFreq));
    }
    
    function updateControls() {
      const t = state[activeTarget];
      
      const gainIdx = gainIndexFromValue(t.gain);
      els.gainSlider.value = gainIdx;
      els.gainValue.textContent = GAIN_STEPS[gainIdx].toFixed(1);
      els.gainApplied.textContent = t.gain.toFixed(1) + ' dB';
      
      const sqlSliderVal = t.squelch / SQL_SCALE;
      els.sqlSlider.value = sqlSliderVal;
      els.sqlValue.textContent = sqlSliderVal.toFixed(1);
      els.sqlApplied.textContent = t.squelch.toFixed(2);
      
      els.filterSlider.value = t.filter;
      els.filterValue.textContent = t.filter;
      els.filterApplied.textContent = t.filter + ' Hz';
    }
    
    function updateProfiles() {
      const t = state[activeTarget];
      
      if (!t.profiles.length) {
        els.profilesList.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><div>No profiles found</div></div>';
        return;
      }
      
      els.profilesList.innerHTML = t.profiles
        .filter(p => !p.id.startsWith('none_'))
        .map(p => `
          <button class="profile-btn ${p.id === t.currentProfile ? 'active' : ''}" 
                  onclick="selectProfile('${p.id}')">
            <div class="label">${p.label}</div>
            <div class="meta">${p.exists ? '' : 'Missing'}</div>
          </button>
        `).join('');
    }
    
    function updateHitList() {
      const header = '<div class="hit-row header"><div>Time</div><div>Frequency</div><div>Dur</div></div>';
      
      if (!state.hits.length) {
        els.hitList.innerHTML = header + '<div class="empty-state"><div class="icon">üìª</div><div>Waiting for hits...</div></div>';
        return;
      }
      
      const rows = state.hits.slice(0, 50).map(hit => `
        <div class="hit-row">
          <div class="time">${hit.time || '--'}</div>
          <div class="freq">${formatFreq(hit.freq)} MHz</div>
          <div class="duration">${hit.duration ? hit.duration + 's' : '--'}</div>
        </div>
      `).join('');
      
      els.hitList.innerHTML = header + rows;
    }
    
    function updateCounters() {
      const elapsed = (Date.now() - state.sessionStart) / 3600000;
      let rate = '--';
      if (elapsed > 0.01 && state.sessionHits > 0) {
        rate = Math.round(state.sessionHits / elapsed);
      }
      
      els.hitCount.textContent = rate;
      els.hitRate.textContent = '';
      
      els.sessionCount.textContent = state.sessionHits;
      
      const startDate = new Date(state.sessionStart);
      els.sessionStart.textContent = 'Since ' + startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const allAvoids = [...state.airband.avoids, ...state.ground.avoids];
      const freqs = allAvoids.map(a => a.freq || a);
      let tableHtml = '--';
      if (freqs.length > 0) {
        tableHtml = '<table style="width:100%; font-size:10px; line-height:1.2;">';
        for (let i = 0; i < freqs.length; i += 2) {
          tableHtml += '<tr>';
          tableHtml += '<td style="text-align:left;">' + freqs[i] + '</td>';
          if (i + 1 < freqs.length) {
            tableHtml += '<td style="text-align:left;">' + freqs[i + 1] + '</td>';
          } else {
            tableHtml += '<td></td>';
          }
          tableHtml += '</tr>';
        }
        tableHtml += '</table>';
      }
      els.avoidsCount.innerHTML = tableHtml;
      els.avoidsTarget.textContent = '';
      
      if (state.serverTime) {
        const serverDate = new Date(state.serverTime * 1000);
        els.piTime.textContent = serverDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
      }
    }
    
    function formatFreq(freq) {
      if (!freq) return '--';
      const num = parseFloat(freq);
      return isNaN(num) ? freq : num.toFixed(3);
    }
    
    function switchTarget(target) {
      activeTarget = target;
      els.tabAirband.classList.toggle('active', target === 'airband');
      els.tabGround.classList.toggle('active', target === 'ground');
      els.gainSlider.classList.remove('dirty');
      els.sqlSlider.classList.remove('dirty');
      els.filterSlider.classList.remove('dirty');
      updateControls();
      updateProfiles();
    }
    
    // ============================================
    // SLIDER HANDLERS
    // ============================================
    
    function onGainChange() {
      const idx = parseInt(els.gainSlider.value);
      const gain = gainValueFromIndex(idx);
      els.gainValue.textContent = gain.toFixed(1);
      els.gainSlider.classList.add('dirty');
      clearTimeout(state.applyTimeout);
      state.applyTimeout = setTimeout(() => applyGainSql(), DEBOUNCE_MS);
    }
    
    function onSqlChange() {
      const val = parseFloat(els.sqlSlider.value);
      els.sqlValue.textContent = val.toFixed(1);
      els.sqlSlider.classList.add('dirty');
      clearTimeout(state.applyTimeout);
      state.applyTimeout = setTimeout(() => applyGainSql(), DEBOUNCE_MS);
    }
    
    function onFilterChange() {
      const val = parseInt(els.filterSlider.value);
      els.filterValue.textContent = val;
      els.filterSlider.classList.add('dirty');
      clearTimeout(state.filterTimeout);
      state.filterTimeout = setTimeout(() => applyFilter(), DEBOUNCE_MS);
    }
    
    async function applyGainSql() {
      const gainIdx = parseInt(els.gainSlider.value);
      const gain = gainValueFromIndex(gainIdx);
      const squelch = parseFloat(els.sqlSlider.value) * SQL_SCALE;
      
      try {
        await postAPI('/api/apply', { target: activeTarget, gain, squelch });
        els.gainSlider.classList.remove('dirty');
        els.sqlSlider.classList.remove('dirty');
        els.gainApplied.textContent = gain.toFixed(1) + ' dB';
        els.sqlApplied.textContent = squelch.toFixed(2);
        state[activeTarget].gain = gain;
        state[activeTarget].squelch = squelch;
      } catch (e) {
        console.error('Apply failed:', e);
      }
    }
    
    async function applyFilter() {
      const cutoff = parseInt(els.filterSlider.value);
      
      try {
        await postAPI('/api/filter', { target: activeTarget, cutoff_hz: cutoff });
        els.filterSlider.classList.remove('dirty');
        els.filterApplied.textContent = cutoff + ' Hz';
        state[activeTarget].filter = cutoff;
      } catch (e) {
        console.error('Filter apply failed:', e);
      }
    }
    
    // ============================================
    // ACTIONS
    // ============================================
    
    function toggleHold() {
      if (state.holdFreq) {
        state.holdFreq = null;
        updateStatus();
        return;
      }
      const live = getLiveDisplayFreq();
      if (live && live !== '--') {
        state.holdFreq = live;
      }
      updateStatus();
    }

    async function selectProfile(id) {
      try {
        await postAPI('/api/profile', { profile: id, target: activeTarget });
        await refresh();
      } catch (e) {
        console.error('Profile switch failed:', e);
      }
    }
    
    function reconnectUI() {
      if (state.eventSource) {
        state.eventSource.close();
        state.eventSource = null;
      }
      connectSSE();
      refresh();
      refreshHits();
    }
    
    // ============================================
    // DATA REFRESH
    // ============================================
    
    async function refresh() {
      try {
        const data = await fetchJSON('/api/status');
        
        state.sdr1Active = data.rtl_active;
        state.sdr2Active = data.ground_active;
        state.icecastActive = data.icecast_active;
        state.lastHit = data.last_hit || data.last_hit_airband || data.last_hit_ground || '';
        
        state.airband.gain = data.airband_gain || data.gain || 32.8;
        state.airband.squelch = data.airband_squelch || data.squelch || 0.5;
        state.airband.filter = data.airband_filter || 3500;
        state.airband.profiles = data.profiles_airband || [];
        state.airband.currentProfile = data.profile_airband || '';
        state.airband.avoids = data.avoids_airband?.sample || [];
        
        state.ground.gain = data.ground_gain || 32.8;
        state.ground.squelch = data.ground_squelch || 0.5;
        state.ground.filter = data.ground_filter || 3500;
        state.ground.profiles = data.profiles_ground || [];
        state.ground.currentProfile = data.profile_ground || '';
        state.ground.avoids = data.avoids_ground?.sample || [];
        
        state.serverTime = data.server_time;
        
        state.connected = true;
        
        updateStatus();
        updateControls();
        updateProfiles();
        updateCounters();
      } catch (e) {
        state.connected = false;
        updateStatus();
        console.error('Refresh failed:', e);
      }
    }
    
    async function refreshHits() {
      try {
        const data = await fetchJSON('/api/hits');
        const newHits = data.items || [];
        
        // Count new hits for session
        if (state.hits.length > 0 && newHits.length > 0) {
          const lastTime = state.hits[0]?.time;
          const newCount = newHits.filter(h => h.time > lastTime).length;
          state.sessionHits += newCount;
        }
        
        state.hits = newHits;
        updateHitList();
        updateCounters();
        updateStatus();
      } catch (e) {
        console.error('Hits refresh failed:', e);
      }
    }
    
    // ============================================
    // SSE STREAM
    // ============================================
    
    function connectSSE() {
      if (state.eventSource) {
        state.eventSource.close();
      }
      const es = new EventSource('/api/stream');
      state.eventSource = es;
      
      es.addEventListener('status', (e) => {
        try {
          const data = JSON.parse(e.data);
          state.sdr1Active = data.rtl_active;
          state.sdr2Active = data.ground_active;
          state.icecastActive = data.icecast_active;
          state.lastHit = data.last_hit || state.lastHit;
          state.serverTime = data.server_time;
          state.connected = true;
          updateStatus();
          updateCounters();
        } catch (err) {
          console.error('SSE status parse error:', err);
        }
      });
      
      es.addEventListener('hits', (e) => {
        try {
          const data = JSON.parse(e.data);
          const newHits = data.items || [];
          
          // Only update if SSE has newer data (don't overwrite polling data with less)
          if (newHits.length === 0) return;
          
          // Check if we have a genuinely new hit at the top
          const currentTop = state.hits[0]?.time;
          const newTop = newHits[0]?.time;
          
          if (newTop && newTop !== currentTop) {
            state.sessionHits++;
            // Merge: prepend new hits we don't have
            const existingTimes = new Set(state.hits.map(h => h.time + h.freq));
            for (let i = newHits.length - 1; i >= 0; i--) {
              const key = newHits[i].time + newHits[i].freq;
              if (!existingTimes.has(key)) {
                state.hits.unshift(newHits[i]);
              }
            }
            state.hits = state.hits.slice(0, 50);
            updateHitList();
            updateCounters();
            updateStatus();
          }
        } catch (err) {
          console.error('SSE hits parse error:', err);
        }
      });
      
      es.onerror = () => {
        state.connected = false;
        updateStatus();
        es.close();
        state.eventSource = null;
        setTimeout(connectSSE, 3000);
      };
      
      es.onopen = () => {
        state.connected = true;
        updateStatus();
      };
    }
    
    // ============================================
    // THEME
    // ============================================
    
    function toggleTheme() {
      document.body.classList.toggle('red-theme');
      const isRed = document.body.classList.contains('red-theme');
      localStorage.setItem('sb3-theme', isRed ? 'red' : 'default');
    }
    
    function loadTheme() {
      const saved = localStorage.getItem('sb3-theme');
      if (saved === 'red') {
        document.body.classList.add('red-theme');
      }
    }
    
    // ============================================
    // INIT
    // ============================================
    
    function init() {
      loadTheme();
      setupCollapsibleWidgets();
      
      els.gainSlider.addEventListener('input', onGainChange);
      els.sqlSlider.addEventListener('input', onSqlChange);
      els.filterSlider.addEventListener('input', onFilterChange);
      els.lastHit.addEventListener('click', toggleHold);
      // Remove Open Squelch button handler, add new handlers
      document.getElementById('btn-play').addEventListener('click', function() {
        window.open(`http://${location.hostname}:8000/GND.mp3`, '_blank', 'noopener');
      });
      document.getElementById('btn-avoid').addEventListener('click', async function() {
        const btn = document.getElementById('btn-avoid');
        btn.disabled = true;
        btn.textContent = 'Avoiding...';
        try {
          await postAPI('/api/avoid', { target: activeTarget });
          await refresh();
          // Refresh again after 2 seconds to catch the config update
          setTimeout(refresh, 2000);
        } catch (e) {
          console.error('Avoid failed:', e);
        }
        btn.disabled = false;
        btn.textContent = 'Avoid';
      });
      document.getElementById('btn-clear-avoids').addEventListener('click', async function() {
        try {
          await postAPI('/api/avoid-clear', { target: activeTarget });
          await refresh();
        } catch (e) {
          console.error('Clear avoids failed:', e);
        }
      });
      els.btnReconnect.addEventListener('click', function() {
        reconnectUI();
      });
      
      refresh();
      refreshHits();
      connectSSE();
      
      // Poll hits more frequently to catch activity
      setInterval(refreshHits, 2000);
      setInterval(refresh, 10000);
    }
    
    init();
  </script>
</body>
</html>
