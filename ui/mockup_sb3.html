<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SB3 - Scanner Box 3 Control</title>
  <style>
    :root {
      --bg-dark: #0a0d11;
      --bg-card: #0f1318;
      --bg-panel: #121618;
      --text-primary: #e4e8f0;
      --text-secondary: #8a92a8;
      --accent: #2dd4bf;
      --accent-alt: #3b82f6;
      --border: #1e2530;
      --good: #10b981;
      --bad: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Menlo, monospace;
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 13px;
      user-select: none;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--accent);
      text-transform: uppercase;
      padding: 4px 6px;
      border: 1px solid var(--accent);
      border-radius: 4px;
    }

    .status {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--good);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .header-right {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .selector {
      display: flex;
      gap: 4px;
    }

    select {
      padding: 4px 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:hover {
      border-color: var(--accent);
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Main Container */
    .main {
      padding: 12px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      grid-auto-rows: max-content;
      gap: 10px;
      grid-auto-flow: row;
    }

    .grid.flavor-widescreen {
      grid-template-columns: repeat(4, 1fr);
    }

    .grid.flavor-compact {
      grid-template-columns: 1fr;
    }

    /* Widget Base */
    .widget {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
      cursor: move;
      position: relative;
    }

    .widget:hover {
      border-color: var(--accent-alt);
    }

    .widget.dragging {
      opacity: 0.7;
      border-color: var(--accent);
    }

    /* Widget Size Presets */
    .widget.size-s .widget-content { height: 150px; }
    .widget.size-m .widget-content { height: 250px; }
    .widget.size-l .widget-content { height: 400px; }
    .widget.size-xl {
      grid-column: span 2;
    }
    .widget.size-xl .widget-content {
      height: 450px; /* 12:9 ratio for ~600px wide widget */
    }

    /* Size buttons in header */
    .size-btns {
      display: flex;
      gap: 2px;
      margin-left: auto;
    }
    .size-btn {
      padding: 2px 6px;
      font-size: 9px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 600;
    }
    .size-btn:hover {
      background: var(--accent);
      color: var(--bg-card);
      border-color: var(--accent);
    }
    .size-btn.active {
      background: var(--accent);
      color: var(--bg-card);
      border-color: var(--accent);
    }

    .widget-header {
      padding: 8px 10px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: grab;
    }

    .widget-header::before {
      content: '‚ãÆ‚ãÆ';
      color: var(--text-secondary);
      font-size: 10px;
      margin-right: 6px;
      opacity: 0.4;
      transition: all 0.2s;
      letter-spacing: 0.5px;
    }

    .widget:hover .widget-header::before {
      opacity: 0.7;
      color: var(--accent);
    }

    .widget-title {
      color: var(--text-secondary);
    }

    .widget-content {
      padding: 12px;
      overflow-y: auto;
      height: 250px;
      transition: height 0.2s ease;
    }

    /* Counter Widget */
    .counter-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .counter-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      text-align: center;
    }

    .counter-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .counter-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      font-family: 'Monaco', monospace;
    }

    .counter-trend {
      font-size: 11px;
      color: var(--good);
    }

    /* Controls Widget */
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
    }

    .control-value {
      color: var(--accent);
      font-family: monospace;
      font-size: 12px;
    }

    .slider {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: linear-gradient(90deg, rgba(45, 212, 191, 0.2), rgba(45, 212, 191, 0.1));
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: all 0.15s;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
    }

    /* Spectrum Widget */
    .spectrum-container {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 150px;
      display: flex;
      flex-direction: column;
    }

    .spectrum-scroll {
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      background: var(--bg-dark);
      border-radius: 4px;
    }

    .spectrum-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .spectrum-scroll::-webkit-scrollbar-track {
      background: var(--bg-panel);
      border-radius: 3px;
    }

    .spectrum-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .spectrum-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    .spectrum-canvas {
      height: 100%;
      min-width: 100%;
      display: block;
    }

    .spectrum-info {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-secondary);
      padding: 4px 0;
      flex-shrink: 0;
    }

    .spectrum-freq {
      color: var(--accent);
      font-weight: 600;
    }

    /* Legacy bar display fallback */
    .spectrum-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 100px;
      margin: 8px 0;
    }

    .bar {
      flex: 1;
      background: linear-gradient(180deg, var(--accent), rgba(45, 212, 191, 0.3));
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: height 0.1s ease-out;
    }

    /* Log Widget */
    .log-entry {
      padding: 6px 0;
      border-bottom: 1px solid rgba(142, 158, 171, 0.05);
      font-family: 'Monaco', monospace;
      font-size: 11px;
      display: grid;
      grid-template-columns: 60px 1fr;
      gap: 8px;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-secondary);
    }

    .log-msg {
      color: var(--text-primary);
    }

    .log-msg.info {
      color: var(--accent-alt);
    }

    .log-msg.good {
      color: var(--good);
    }

    .log-msg.warn {
      color: #f59e0b;
    }

    /* Buttons */
    .btn-group {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    button {
      flex: 1;
      padding: 6px 10px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    button:hover {
      border-color: var(--accent);
      background: rgba(45, 212, 191, 0.05);
    }

    button.primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    button.primary:hover {
      background: rgba(45, 212, 191, 0.1);
    }

    /* Theme Variation */
    .theme-blue {
      --accent: #3b82f6;
      --accent-alt: #06b6d4;
    }

    .theme-purple {
      --accent: #a855f7;
      --accent-alt: #ec4899;
    }

    .theme-amber {
      --accent: #f59e0b;
      --accent-alt: #fbbf24;
    }

    .theme-red {
      --accent: #dc2626;
      --accent-alt: #991b1b;
      --bg-dark: #0a0606;
      --bg-card: #1a0f0f;
      --bg-panel: #2d1515;
      --text-primary: #fde8e8;
      --text-secondary: #a07070;
      --border: #451515;
      --good: #b91c1c;
    }

    /* Grid positioning */
    .widget-counter { }
    .widget-controls { }
    .widget-spectrum { }
    .widget-log { }

    /* Profiles Widget */
    .profiles {
      display: grid;
      gap: 6px;
    }

    .profile-btn {
      padding: 8px 10px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .profile-btn:hover {
      border-color: var(--accent);
    }

    .profile-btn.active {
      border-color: var(--accent);
      background: rgba(45, 212, 191, 0.1);
    }

    .profile-signal {
      font-size: 11px;
      color: var(--accent);
      font-family: monospace;
    }

    /* Iframe Widget */
    .widget-iframe {
      overflow: hidden;
    }

    .widget-iframe .widget-content {
      padding: 0;
      height: 400px;
    }

    .widget-iframe iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0 0 6px 6px;
      display: block;
    }

    .widget-iframe.compact .widget-content {
      height: 250px;
    }

    .widget-iframe.tall .widget-content {
      height: 600px;
    }

    @media (max-width: 768px) {
      .widget-iframe .widget-content {
        height: 300px;
      }
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">SB3</div>
      <div class="status">
        <span class="status-dot"></span>
        <span>Ready</span>
      </div>
    </div>

    <div class="header-right">
      <div class="selector">
        <select id="theme-select" onchange="changeTheme(this.value)">
          <option value="default">Teal</option>
          <option value="theme-blue">Blue</option>
          <option value="theme-purple">Purple</option>
          <option value="theme-amber">Amber</option>
          <option value="theme-red">Red</option>
        </select>

        <select id="flavor-select" onchange="changeFlavor(this.value)">
          <option value="flavor-default">Balanced</option>
          <option value="flavor-widescreen">Widescreen</option>
          <option value="flavor-compact">Compact</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="grid flavor-default" id="grid">

      <!-- Counter Widget -->
      <div class="widget widget-counter size-m">
        <div class="widget-header">
          <span class="widget-title">üìä Signal Counts</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <div class="counter-grid">
            <div class="counter-item">
              <div class="counter-label">Airband</div>
              <div class="counter-number">247</div>
              <div class="counter-trend">‚Üë 12/hr</div>
            </div>
            <div class="counter-item">
              <div class="counter-label">Ground</div>
              <div class="counter-number">89</div>
              <div class="counter-trend">‚Üë 4/hr</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls Widget -->
      <div class="widget widget-controls size-m">
        <div class="widget-header">
          <span class="widget-title">‚öôÔ∏è Radio Controls</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <div class="control-group">
            <div class="control-item">
              <div class="control-label">
                <span>Gain</span>
                <span class="control-value" id="gain-val">16</span>
              </div>
              <input type="range" class="slider" min="0" max="28" value="16" id="gain-slider" oninput="updateValue('gain', this.value)">
            </div>

            <div class="control-item">
              <div class="control-label">
                <span>Squelch</span>
                <span class="control-value" id="sql-val">4.2</span>
              </div>
              <input type="range" class="slider" min="0" max="10" value="4.2" step="0.1" id="sql-slider" oninput="updateValue('sql', this.value)">
            </div>

            <div class="control-item">
              <div class="control-label">
                <span>Filter (Hz)</span>
                <span class="control-value" id="filter-val">3500</span>
              </div>
              <input type="range" class="slider" min="2000" max="5000" step="100" value="3500" id="filter-slider" oninput="updateValue('filter', this.value)">
            </div>
          </div>

          <div class="btn-group">
            <button class="primary" onclick="applySettings()">Apply</button>
            <button onclick="resetSettings()">Reset</button>
          </div>
        </div>
      </div>

      <!-- Profiles Widget -->
      <div class="widget widget-profiles size-m">
        <div class="widget-header">
          <span class="widget-title">üéØ Profiles</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <div class="profiles">
            <div class="profile-btn active">
              <span>Airband</span>
              <span class="profile-signal">+16dB</span>
            </div>
            <div class="profile-btn">
              <span>Tower</span>
              <span class="profile-signal">+14dB</span>
            </div>
            <div class="profile-btn">
              <span>ATIS</span>
              <span class="profile-signal">+12dB</span>
            </div>
            <div class="profile-btn">
              <span>Weather</span>
              <span class="profile-signal">+10dB</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Spectrum Widget -->
      <div class="widget widget-spectrum size-m">
        <div class="widget-header">
          <span class="widget-title">üìà Spectrum</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <div class="spectrum-container">
            <div class="spectrum-scroll" id="spectrum-scroll">
              <canvas id="spectrum-canvas" class="spectrum-canvas"></canvas>
            </div>
            <div class="spectrum-info">
              <span id="spectrum-count">15 frequencies</span>
              <span class="spectrum-freq" id="spectrum-peak">Monitoring...</span>
              <span>‚Üê scroll ‚Üí</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Log Widget -->
      <div class="widget widget-log size-m">
        <div class="widget-header">
          <span class="widget-title">üìã Activity Log</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <div class="log-entry">
            <div class="log-time">14:23:18</div>
            <div class="log-msg good">‚úì Airband hit 134.225 MHz (2.3s)</div>
          </div>
          <div class="log-entry">
            <div class="log-time">14:22:45</div>
            <div class="log-msg good">‚úì Ground hit 127.850 MHz (1.8s)</div>
          </div>
          <div class="log-entry">
            <div class="log-time">14:22:12</div>
            <div class="log-msg info">‚Ñπ Squelch opened on Airband</div>
          </div>
          <div class="log-entry">
            <div class="log-time">14:21:30</div>
            <div class="log-msg warn">‚ö† Airband gain increased to 18 dB</div>
          </div>
          <div class="log-entry">
            <div class="log-time">14:20:45</div>
            <div class="log-msg">RTL-SDR initialized</div>
          </div>
        </div>
      </div>

      <!-- ADSB Browser Widget -->
      <div class="widget widget-iframe widget-adsb size-m">
        <div class="widget-header">
          <span class="widget-title">‚úàÔ∏è Live ADSB</span>
          <div class="size-btns">
            <button class="size-btn" onclick="setSize(this, 's')">S</button>
            <button class="size-btn active" onclick="setSize(this, 'm')">M</button>
            <button class="size-btn" onclick="setSize(this, 'l')">L</button>
            <button class="size-btn" onclick="setSize(this, 'xl')">XL</button>
          </div>
        </div>
        <div class="widget-content">
          <iframe src="https://adsb.lol/" title="Live ADSB Map"></iframe>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Theme and flavor controls
    function changeTheme(theme) {
      document.body.className = theme === 'default' ? '' : theme;
    }

    function changeFlavor(flavor) {
      document.getElementById('grid').className = 'grid ' + flavor;
    }

    function updateValue(type, value) {
      document.getElementById(type + '-val').textContent = value;
    }
    
    // Apply settings to real backend
    async function applySettings() {
      const gain = document.getElementById('gain-slider').value;
      const squelch = document.getElementById('sql-slider').value;
      
      try {
        const response = await fetch(API_BASE + '/api/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `target=airband&gain=${gain}&squelch=${squelch}`
        });
        const data = await response.json();
        if (data.ok) {
          console.log('Settings applied');
        } else {
          alert('Error: ' + (data.error || 'Failed to apply'));
        }
      } catch (e) {
        console.error('Apply failed:', e);
      }
    }
    
    // Reset to values from server
    function resetSettings() {
      // SSE will update with current values
      console.log('Waiting for SSE to refresh values...');
    }

    // Size presets - S, M, L, XL
    function setSize(btn, size) {
      const widget = btn.closest('.widget');
      
      // Remove all size classes
      widget.classList.remove('size-s', 'size-m', 'size-l', 'size-xl');
      
      // Add new size class
      widget.classList.add('size-' + size);
      
      // Update active button
      const btns = widget.querySelectorAll('.size-btn');
      btns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Resize canvas if it's the spectrum widget
      if (widget.classList.contains('widget-spectrum')) {
        setTimeout(resizeSpectrumCanvas, 100);
      }
    }

    // Profile buttons
    document.querySelectorAll('.profile-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.profile-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // ============================================
    // FREQUENCY MONITOR (stats_filepath based)
    // ============================================
    
    const API_BASE = window.location.port === '8889' 
      ? 'http://localhost:5050'  // Dev: mockup on 8889, API on 5050
      : '';                       // Prod: same origin
    
    // Spectrum state
    let spectrumCanvas, spectrumCtx;
    let spectrumData = [];
    let spectrumHistory = [];
    const HISTORY_DEPTH = 30;
    const NOISE_FLOOR = -100;
    const SIGNAL_MAX = -60;
    
    // Simulation mode (when API unavailable)
    let simulationMode = false;
    
    // Your actual configured frequencies from rtl_airband_airband.conf
    const CONFIGURED_FREQS = [
      { freq: 118.4, label: 'Dep E' },
      { freq: 118.6, label: 'Tower' },
      { freq: 119.35, label: 'Dep W' },
      { freq: 119.45, label: 'App' },
      { freq: 121.9, label: 'Gnd' },
      { freq: 124.75, label: 'Final' },
      { freq: 126.05, label: 'Clnc' },
      { freq: 127.175, label: 'App2' },
      { freq: 128.825, label: 'UAL' },
      { freq: 129.95, label: 'Ramp' },
      { freq: 130.125, label: 'SWA' },
      { freq: 130.725, label: 'FFT' },
      { freq: 131.375, label: 'Ramp2' },
      { freq: 131.45, label: 'DAL' },
      { freq: 135.1, label: 'ATIS' }
    ];
    
    const MIN_BAR_WIDTH = 35; // Minimum pixels per frequency bar
    const BAR_GAP = 3;
    
    function initSpectrum() {
      spectrumCanvas = document.getElementById('spectrum-canvas');
      if (!spectrumCanvas) return;
      
      spectrumCtx = spectrumCanvas.getContext('2d');
      
      // Initialize spectrum data with configured frequencies
      spectrumData = CONFIGURED_FREQS.map(f => ({
        ...f,
        power: NOISE_FLOOR,
        active: false,
        count: 0
      }));
      
      resizeSpectrumCanvas();
      
      // Try to connect to SSE stream
      connectSSE();
      
      // Start simulation as fallback
      setTimeout(() => {
        if (simulationMode) {
          simulateSpectrum();
        }
      }, 2000);
      
      // Render loop
      requestAnimationFrame(renderSpectrum);
    }
    
    function resizeSpectrumCanvas() {
      if (!spectrumCanvas) return;
      const scroll = document.getElementById('spectrum-scroll');
      if (!scroll) return;
      
      const numBins = spectrumData.length || CONFIGURED_FREQS.length;
      const containerWidth = scroll.clientWidth;
      const neededWidth = numBins * (MIN_BAR_WIDTH + BAR_GAP) + 20;
      
      // Use larger of container width or needed width
      spectrumCanvas.width = Math.max(containerWidth, neededWidth);
      spectrumCanvas.height = scroll.clientHeight || 200;
      
      // Update frequency count display
      const countEl = document.getElementById('spectrum-count');
      if (countEl) {
        countEl.textContent = `${numBins} frequencies`;
      }
    }
    
    function connectSSE() {
      try {
        const eventSource = new EventSource(API_BASE + '/api/stream');
        
        eventSource.addEventListener('spectrum', (e) => {
          const data = JSON.parse(e.data);
          if (data.bins && data.bins.length > 0) {
            simulationMode = false;
            spectrumData = data.bins;
            updateHistory();
          }
        });
        
        eventSource.addEventListener('status', (e) => {
          const data = JSON.parse(e.data);
          updateStatusWidgets(data);
        });
        
        eventSource.addEventListener('hits', (e) => {
          const data = JSON.parse(e.data);
          updateHitsWidget(data.items);
        });
        
        eventSource.onerror = () => {
          console.log('SSE connection failed');
          // simulationMode = true;  // Stay false - wait for real data
          eventSource.close();
        };
      } catch (e) {
        console.log('SSE connection failed');
        // simulationMode = true;  // Stay false - wait for real data
      }
    }
    
    function simulateSpectrum() {
      if (!simulationMode) return;
      
      // Simulate noise floor changes and occasional activity
      spectrumData = spectrumData.map((bin, i) => {
        let power = NOISE_FLOOR + Math.random() * 5;
        let active = false;
        
        // Some frequencies are more active than others
        const activityChance = [1,3,5,7,8].includes(i) ? 0.2 : 0.05;
        if (Math.random() < activityChance) {
          power = NOISE_FLOOR + 20 + Math.random() * 20;
          active = true;
        }
        
        return {
          ...bin,
          power: power,
          active: active,
          count: bin.count + (active ? 1 : 0)
        };
      });
      
      updateHistory();
      setTimeout(simulateSpectrum, 1000);
    }
    
    function updateHistory() {
      spectrumHistory.unshift(spectrumData.map(b => ({ power: b.power, active: b.active })));
      if (spectrumHistory.length > HISTORY_DEPTH) {
        spectrumHistory.pop();
      }
    }
    
    function renderSpectrum() {
      if (!spectrumCtx || !spectrumCanvas) {
        requestAnimationFrame(renderSpectrum);
        return;
      }
      
      const w = spectrumCanvas.width;
      const h = spectrumCanvas.height;
      
      // Clear
      spectrumCtx.fillStyle = '#0a0f0f';
      spectrumCtx.fillRect(0, 0, w, h);
      
      // If no data, show message
      if (spectrumData.length === 0) {
        spectrumCtx.fillStyle = '#8a92a8';
        spectrumCtx.font = '14px -apple-system, sans-serif';
        spectrumCtx.textAlign = 'center';
        spectrumCtx.fillText('Spectrum data unavailable', w/2, h/2 - 10);
        spectrumCtx.font = '11px -apple-system, sans-serif';
        spectrumCtx.fillText('(requires rtl_airband with stats_filepath)', w/2, h/2 + 10);
        requestAnimationFrame(renderSpectrum);
        return;
      }
      
      const numBins = spectrumData.length;
      // Use consistent bar width from constant
      const barWidth = MIN_BAR_WIDTH;
      const historyH = h * 0.35;
      const barsH = h - historyH - 25;
      
      // Draw history (mini waterfall)
      const histRowH = historyH / HISTORY_DEPTH;
      for (let row = 0; row < spectrumHistory.length; row++) {
        const rowData = spectrumHistory[row];
        for (let i = 0; i < rowData.length; i++) {
          const x = 10 + i * (barWidth + BAR_GAP);
          const y = row * histRowH;
          const normalized = Math.max(0, Math.min(1, (rowData[i].power - NOISE_FLOOR) / (SIGNAL_MAX - NOISE_FLOOR)));
          
          if (rowData[i].active) {
            spectrumCtx.fillStyle = `hsl(${160 - normalized * 160}, 90%, ${20 + normalized * 35}%)`;
          } else {
            spectrumCtx.fillStyle = `hsl(200, 30%, ${8 + normalized * 12}%)`;
          }
          spectrumCtx.fillRect(x, y, barWidth, histRowH);
        }
      }
      
      // Draw separator line
      spectrumCtx.strokeStyle = 'rgba(45, 212, 191, 0.3)';
      spectrumCtx.beginPath();
      spectrumCtx.moveTo(0, historyH);
      spectrumCtx.lineTo(w, historyH);
      spectrumCtx.stroke();
      
      // Draw frequency bars
      let activeFreq = null;
      for (let i = 0; i < numBins; i++) {
        const bin = spectrumData[i];
        const x = 10 + i * (barWidth + BAR_GAP);
        const normalized = Math.max(0, Math.min(1, (bin.power - NOISE_FLOOR) / (SIGNAL_MAX - NOISE_FLOOR)));
        const barH = Math.max(4, barsH * normalized);
        const y = historyH + 5 + (barsH - barH);
        
        // Bar gradient
        const gradient = spectrumCtx.createLinearGradient(x, y + barH, x, y);
        if (bin.active) {
          gradient.addColorStop(0, 'rgba(45, 212, 191, 0.4)');
          gradient.addColorStop(1, '#2dd4bf');
          activeFreq = bin;
        } else {
          gradient.addColorStop(0, 'rgba(45, 212, 191, 0.1)');
          gradient.addColorStop(1, 'rgba(45, 212, 191, 0.4)');
        }
        
        spectrumCtx.fillStyle = gradient;
        spectrumCtx.fillRect(x, y, barWidth, barH);
        
        // Activity indicator dot
        if (bin.active) {
          spectrumCtx.fillStyle = '#2dd4bf';
          spectrumCtx.beginPath();
          spectrumCtx.arc(x + barWidth/2, historyH + 5 + barsH + 8, 3, 0, Math.PI * 2);
          spectrumCtx.fill();
        }
        
        // Frequency label - show all since we have scroll room
        spectrumCtx.fillStyle = bin.active ? '#2dd4bf' : 'rgba(142, 158, 171, 0.6)';
        spectrumCtx.font = '9px Monaco, monospace';
        spectrumCtx.textAlign = 'center';
        spectrumCtx.fillText(bin.label || bin.freq.toFixed(1), x + barWidth/2, h - 2);
      }
      
      // Update peak display
      const peakEl = document.getElementById('spectrum-peak');
      if (peakEl) {
        if (activeFreq) {
          peakEl.textContent = `Active: ${activeFreq.freq.toFixed(3)} MHz (${activeFreq.label})`;
          peakEl.style.color = '#2dd4bf';
        } else {
          peakEl.textContent = 'Monitoring...';
          peakEl.style.color = '';
        }
      }
      
      requestAnimationFrame(renderSpectrum);
    }
    
    function updateStatusWidgets(data) {
      if (data.gain !== undefined) {
        const gainSlider = document.getElementById('gain-slider');
        const gainVal = document.getElementById('gain-val');
        if (gainSlider) gainSlider.value = data.gain;
        if (gainVal) gainVal.textContent = data.gain;
      }
      if (data.squelch !== undefined) {
        const sqlSlider = document.getElementById('sql-slider');
        const sqlVal = document.getElementById('sql-val');
        if (sqlSlider) sqlSlider.value = data.squelch;
        if (sqlVal) sqlVal.textContent = data.squelch;
      }
    }
    
    function updateHitsWidget(hits) {
      const logContent = document.querySelector('.widget-log .widget-content');
      if (!logContent || !hits || hits.length === 0) return;
      
      logContent.innerHTML = hits.slice(0, 10).map(hit => `
        <div class="log-entry">
          <div class="log-time">${hit.time || '--:--:--'}</div>
          <div class="log-msg good">‚úì ${hit.freq} MHz (${hit.duration || 0}s)</div>
        </div>
      `).join('');
    }
    
    // Initialize on load
    window.addEventListener('load', initSpectrum);
    window.addEventListener('resize', resizeSpectrumCanvas);
  </script>
</body>
</html>
